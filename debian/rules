#!/usr/bin/make -f

CC =gcc
STRIP =strip

include /usr/share/dpkg/default.mk


DIR =$(shell pwd)/debian/runit

patch: deb-checkdir patch-stamp
patch-stamp:
	touch patch-stamp

build: deb-checkdir build-stamp
build-stamp: patch-stamp
	-gcc -v
	test -e runit || ln -s runit-'$(DEB_VERSION_UPSTREAM)' runit
	test -r conf-cc'{orig}' || cp -f runit/src/conf-cc conf-cc'{orig}'
	echo '$(CC) $(CFLAGS)' >runit/src/conf-cc
	test -r conf-ld'{orig}' || cp -f runit/src/conf-ld conf-ld'{orig}'
	echo '$(CC) $(LDFLAGS)' >runit/src/conf-ld
	(cd runit/ && package/compile && package/check)
	touch build-stamp

clean: deb-checkdir deb-checkuid
	rm -rf runit/compile runit/command
	test ! -e patch-stamp || \
	  for i in `ls -1r debian/diff/*.diff || :`; do patch -p1 -R <$$i; done
	rm -f patch-stamp build-stamp
	rm -rf '$(DIR)'
	rm -f debian/files debian/substvars changelog
	test ! -r conf-cc'{orig}' || mv -f conf-cc'{orig}' runit/src/conf-cc
	test ! -r conf-ld'{orig}' || mv -f conf-ld'{orig}' runit/src/conf-ld
	rm -f runit

install: deb-checkdir deb-checkuid build-stamp
	rm -rf '$(DIR)'
	install -d -m0755 '$(DIR)'/etc/service
	install -d -m0755 '$(DIR)'/var/lib/supervise
	install -d -m0755 '$(DIR)'/sbin
	install -d -m0755 '$(DIR)'/usr/bin
	install -d -m0755 '$(DIR)'/usr/sbin
	for i in runit runit-init; do \
	  install -m0755 runit/command/$$i '$(DIR)'/sbin/ || exit 1; \
	done
	for i in runsvdir runsv sv svlogd chpst; do \
	  install -m0755 runit/command/$$i '$(DIR)'/usr/bin/ || exit 1; \
	done
	for i in runsvchdir utmpset; do \
	  install -m0755 runit/command/$$i '$(DIR)'/usr/sbin/ || exit 1; \
	done
	$(STRIP) -R .comment -R .note '$(DIR)'/sbin/* '$(DIR)'/usr/sbin/* \
	  '$(DIR)'/usr/bin/*
	# runsvdir-start to be used from /etc/inittab
	install -m0755 debian/2 '$(DIR)'/usr/sbin/runsvdir-start
	# update-service
	install -m0755 debian/update-service '$(DIR)'/usr/sbin/update-service
	# getty-5 service
	install -d -m0755 '$(DIR)'/etc/sv/getty-5
	install -m0755 debian/getty-tty5.run '$(DIR)'/etc/sv/getty-5/run
	install -m0755 debian/getty-tty5.finish \
	  '$(DIR)'/etc/sv/getty-5/finish
	# bash completion
	install -d -m0755 '$(DIR)'/usr/share/bash-completion/completions
	install -m0644 debian/contrib/sv-completion.bash \
	  '$(DIR)'/usr/share/bash-completion/completions/sv
	# man pages
	install -d -m0755 '$(DIR)'/usr/share/man/man8
	for i in runit runit-init runsvdir runsv sv svlogd chpst runsvchdir \
	 utmpset; do \
	  install -m0644 runit/man/$$i.8 \
	    '$(DIR)'/usr/share/man/man8/ || exit 1; \
	done
	install -m0644 debian/runsvdir-start.8 '$(DIR)'/usr/share/man/man8/
	install -m0644 debian/update-service.8 '$(DIR)'/usr/share/man/man8/
	gzip -9 '$(DIR)'/usr/share/man/man8/*.8
	# links
	ln -s /var/run/sv.getty-5 '$(DIR)'/etc/sv/getty-5/supervise
	# additional docs
	install -d -m0755 '$(DIR)'/usr/share/doc/runit/debian
	for i in 1 2 3 ctrlaltdel; do \
	  install -m0644 runit/etc/debian/$$i \
	    '$(DIR)'/usr/share/doc/runit/debian/ || exit 1; \
	done
	#  systemd service
	install -d -m0755 '$(DIR)'/lib/systemd/system
	install -m0644 debian/systemd/runit.service \
	  '$(DIR)'/lib/systemd/system/

	#  workaround #766187
	install -d -m0755 '$(DIR)'/usr/share/runit
	#  copy from sysvinit-2.88dsf/debian/rules and adjust
	if test -e debian/share/inittab.$(DEB_HOST_GNU_TYPE) ; \
	then \
		install -m0644 \
			debian/share/inittab.$(DEB_HOST_GNU_TYPE) \
			'$(DIR)'/usr/share/runit/inittab ; \
	elif test -e debian/share/inittab.$(DEB_HOST_GNU_SYSTEM) ; \
	then \
		install -m0644 \
			debian/share/inittab.$(DEB_HOST_GNU_SYSTEM) \
			'$(DIR)'/usr/share/runit/inittab ; \
	else \
		install -m0644 debian/share/inittab \
			'$(DIR)'/usr/share/runit/inittab ; \
	fi
	#  end copy from sysvinit-2.88dsf

	# changelog
	rm -f changelog && ln -s runit/package/CHANGES changelog

binary-indep:

binary-arch: install runit.deb
	test '$(CC)' != 'gcc' || \
	  dpkg-shlibdeps '$(DIR)'/usr/sbin/* '$(DIR)'/usr/bin/*
	dpkg-gencontrol -isp -prunit -P'$(DIR)'
	dpkg -b '$(DIR)' ..

binary: binary-indep binary-arch

.PHONY: patch build clean install binary-indep binary-arch binary

include debian/implicit
